name: Deploy to NUC

on:
  push:
    branches:
      - main  # Trigger on push to main branch
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to NUC
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.NUC_SSH_KEY }}
          SSH_HOST: ${{ secrets.NUC_HOST }}
          SSH_USER: ${{ secrets.NUC_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

      - name: Deploy to NUC via SSH
        env:
          SSH_HOST: ${{ secrets.NUC_HOST }}
          SSH_USER: ${{ secrets.NUC_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          APP_KEY: ${{ secrets.APP_KEY }}
        run: |
          ssh $SSH_USER@$SSH_HOST << 'ENDSSH'
            set -e

            echo "üöÄ Starting deployment..."

            # Navigate to deployment directory
            cd ${{ secrets.DEPLOY_PATH }}

            # Pull latest changes
            echo "üì• Pulling latest code from GitHub..."
            git pull origin main

            # Create .env if not exists
            if [ ! -f .env ]; then
              echo "üìù Creating .env file..."
              cp .env.docker .env
              echo "APP_KEY=${{ secrets.APP_KEY }}" >> .env
              echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            fi

            # Build and restart containers
            echo "üèóÔ∏è  Building Docker containers..."
            docker-compose down
            docker-compose build --no-cache

            echo "üöÄ Starting containers..."
            docker-compose up -d

            # Wait for containers to be ready
            echo "‚è≥ Waiting for containers to be healthy..."
            sleep 30

            # Run migrations
            echo "üìä Running database migrations..."
            docker-compose exec -T app php artisan migrate --force

            # Clear and optimize caches
            echo "üßπ Clearing caches..."
            docker-compose exec -T app php artisan config:cache
            docker-compose exec -T app php artisan route:cache
            docker-compose exec -T app php artisan view:cache
            docker-compose exec -T app php artisan optimize

            # Restart queue workers
            echo "‚ôªÔ∏è  Restarting queue workers..."
            docker-compose restart queue scheduler

            echo "‚úÖ Deployment completed successfully!"

            # Show container status
            echo "üìä Container status:"
            docker-compose ps
          ENDSSH

      - name: Health Check
        env:
          SSH_HOST: ${{ secrets.NUC_HOST }}
          SSH_USER: ${{ secrets.NUC_USER }}
        run: |
          ssh $SSH_USER@$SSH_HOST << 'ENDSSH'
            echo "üè• Running health check..."

            # Check if app is responding
            response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/health || echo "000")

            if [ "$response" = "200" ]; then
              echo "‚úÖ Application is healthy!"
            else
              echo "‚ùå Application health check failed (HTTP $response)"
              exit 1
            fi
          ENDSSH

      - name: Send Notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deployment to NUC completed successfully!"
          else
            echo "‚ùå Deployment to NUC failed!"
          fi
